<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Get Your Boxx - Sternenkarte Konfigurator</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=EB+Garamond:wght@400;700&family=Montserrat:wght@300;500;800&family=Playfair+Display:wght@400;500;600;700&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-light: #f5f3f0;
      --bg-cream: #eae6e0;
      --bg-warm: #e0dbd4;
      --card-bg: #ffffff;
      --copper: #E89F02;
      --copper-dark: #c98a02;
      --copper-light: #f5b52a;
      --text-dark: #1a1a1a;
      --text-medium: #4a4a4a;
      --text-light: #7a7a7a;
      --border-light: rgba(0,0,0,0.08);
      --shadow-soft: 0 4px 20px rgba(0,0,0,0.08);
      --shadow-medium: 0 8px 40px rgba(0,0,0,0.12);
      --error: #d32f2f;
      --success: #388e3c;
    }
    * { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
    body { font-family:'Outfit',sans-serif; background:var(--bg-light); color:var(--text-dark); display:flex; justify-content:center; padding:12px; min-height:100vh; -webkit-font-smoothing:antialiased; }
    body::before { content:''; position:fixed; top:0; left:0; width:100%; height:100%; background-image:radial-gradient(circle at 25% 25%,rgba(232,159,2,0.03) 0%,transparent 50%),radial-gradient(circle at 75% 75%,rgba(232,159,2,0.02) 0%,transparent 50%); pointer-events:none; z-index:0; }

    .app { position:relative; z-index:2; display:grid; grid-template-columns:340px 1fr; gap:30px; width:100%; max-width:1400px; }
    .sidebar { background:var(--card-bg); padding:22px; border-radius:20px; border:1px solid var(--border-light); height:fit-content; box-shadow:var(--shadow-soft); }

    .brand-header { text-align:center; border-bottom:1px solid var(--border-light); padding-bottom:14px; margin-bottom:14px; }
    .brand-name { font-family:'Playfair Display',serif; font-size:1.5rem; color:var(--copper); letter-spacing:0.08em; font-weight:600; line-height:1; }
    .brand-tagline { font-family:'Outfit',sans-serif; font-size:0.65rem; color:var(--text-light); text-transform:uppercase; letter-spacing:0.2em; margin-top:4px; }
    .logo-mark { width:50px; height:2px; background:linear-gradient(90deg,transparent,var(--copper),transparent); margin:10px auto 0; border-radius:2px; }

    .intro { font-size:0.78rem; color:var(--text-light); line-height:1.5; margin:0 0 14px; font-weight:400; text-align:center; }
    .specs-box { background:rgba(232,159,2,0.08); border:1px solid rgba(232,159,2,0.25); color:var(--copper-dark); padding:8px; text-align:center; border-radius:8px; margin-bottom:16px; font-size:0.78rem; font-weight:600; letter-spacing:0.03em; }

    .info-box { background:var(--bg-light); padding:8px 10px; border-radius:6px; border-left:3px solid var(--copper); margin-top:5px; font-size:0.65rem; color:var(--text-light); line-height:1.35; }
    .info-box strong { color:var(--text-dark); }

    .group { margin-bottom:12px; }
    label { display:block; font-size:0.6rem; color:var(--text-light); text-transform:uppercase; margin-bottom:4px; letter-spacing:0.1em; font-weight:600; }
    .input-row { display:flex; align-items:stretch; gap:6px; }
    input:not([type="checkbox"]),select { flex-grow:1; padding:10px 12px; background:var(--bg-light); color:var(--text-dark); border:1px solid var(--border-light); border-left:3px solid var(--border-light); border-radius:8px; font-size:0.85rem; transition:all .2s; font-family:inherit; }
    select option { background:var(--card-bg); color:var(--text-dark); }
    .toggle-check { width:22px; height:22px; min-width:22px; margin:0; cursor:pointer; accent-color:var(--copper); border:1px solid var(--border-light); background:var(--bg-cream); border-radius:6px; }
    input:disabled,select:disabled { opacity:.35; background:var(--bg-warm); border-color:transparent; color:var(--text-light); cursor:not-allowed; }
    .missing { border-color:var(--error)!important; border-left-color:var(--error)!important; background:rgba(211,47,47,0.04)!important; }
    .valid { border-color:var(--success)!important; border-left-color:var(--success)!important; background:rgba(56,142,60,0.04)!important; }
    input:focus:not(:disabled),select:focus:not(:disabled) { outline:none; border-color:var(--copper); box-shadow:0 0 0 3px rgba(232,159,2,0.1); }
    .status { font-size:0.6rem; color:var(--text-light); margin-top:2px; text-align:right; min-height:12px; }

    /* CHIPS */
    .chips { display:flex; flex-wrap:wrap; gap:5px; }
    .chip { padding:6px 11px; background:var(--bg-light); border:1px solid var(--border-light); border-radius:20px; font-size:0.7rem; color:var(--text-medium); cursor:pointer; transition:all .2s; white-space:nowrap; }
    .chip:hover { border-color:var(--copper); color:var(--copper); }
    .chip.active { border-color:var(--copper); color:var(--copper); background:rgba(232,159,2,0.08); }
    .chip-cat { font-size:0.55rem; color:var(--text-light); text-transform:uppercase; letter-spacing:0.1em; width:100%; margin-top:4px; font-weight:500; }
    .chip-cat:first-child { margin-top:0; }

    /* CTA */
    .cta-area { margin-top:14px; }
    .btn-row { display:flex; align-items:stretch; gap:10px; }
    .price-tag { display:flex; flex-direction:column; align-items:center; justify-content:center; background:rgba(232,159,2,0.08); border:1px solid rgba(232,159,2,0.25); border-radius:12px; padding:8px 14px; min-width:72px; }
    .price-tag .amount { font-family:'Playfair Display',serif; font-size:1.5rem; font-weight:600; color:var(--copper); line-height:1; }
    .price-tag .price-sub { font-size:0.48rem; color:var(--text-light); text-transform:uppercase; letter-spacing:0.03em; margin-top:2px; line-height:1.2; text-align:center; }
    .btn-wa { flex:1; padding:14px; background:#25D366; border:none; border-radius:12px; color:#fff; display:flex; align-items:center; justify-content:center; gap:10px; transition:all .3s; cursor:pointer; box-shadow:0 6px 20px rgba(37,211,102,0.3); font-family:inherit; }
    .btn-wa:disabled { background:var(--bg-warm); color:var(--text-light); opacity:0.6; cursor:not-allowed; box-shadow:none; }
    .btn-wa:hover:not(:disabled) { background:#1fb855; transform:translateY(-2px); box-shadow:0 10px 30px rgba(37,211,102,0.4); }
    .btn-wa:active:not(:disabled) { transform:translateY(0); }
    .cta-text { display:flex; flex-direction:column; line-height:1.2; text-align:left; }
    .cta-text strong { font-size:0.85rem; font-weight:600; }
    .cta-text small { font-size:0.65rem; opacity:0.9; font-weight:400; }
    .spinner { width:22px; height:22px; animation:spin 1s linear infinite; }
    @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }

    /* TRUST */
    .trust-bar { display:flex; justify-content:center; gap:16px; margin-top:12px; padding-top:12px; border-top:1px solid var(--border-light); }
    .trust-item { font-size:0.55rem; color:var(--text-light); text-align:center; line-height:1.3; }
    .trust-item span { display:block; font-size:0.8rem; margin-bottom:1px; }

    /* PREVIEW + SLATE */
    .preview { display:flex; flex-direction:column; align-items:center; }
    .slate { position:relative; width:620px; height:620px; overflow:hidden;
      box-shadow:0 8px 25px rgba(0,0,0,0.25),0 3px 10px rgba(0,0,0,0.15),inset 0 1px 0 rgba(255,255,255,0.1); border-radius:4px; }
    .slate-base { position:absolute; top:0; left:0; width:100%; height:100%; z-index:1;
      background:
        repeating-linear-gradient(178deg,#1a1c1e 0px,#1f2123 3px,#1c1e20 8px,#212325 12px,#1d1f21 18px,#202224 22px,#1b1d1f 28px,#1e2022 35px),
        linear-gradient(165deg,transparent 0%,rgba(30,32,34,0.3) 8%,transparent 10%,transparent 25%,rgba(25,27,29,0.25) 27%,transparent 29%,transparent 50%,rgba(35,37,39,0.2) 52%,transparent 54%,transparent 70%,rgba(22,24,26,0.25) 72%,transparent 74%,transparent 90%,rgba(28,30,32,0.2) 92%,transparent 94%),
        linear-gradient(135deg,#1a1c1e 0%,#1e2022 20%,#191b1d 40%,#202224 60%,#1c1e20 80%,#1d1f21 100%); }
    .slate-texture { position:absolute; top:0; left:0; width:100%; height:100%; z-index:2; mix-blend-mode:soft-light; opacity:0.2;
      background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='slate'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.015 0.08' numOctaves='5' seed='15' stitchTiles='stitch' result='noise'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23slate)'/%3E%3C/svg%3E"); }
    .slate-grain { position:absolute; top:0; left:0; width:100%; height:100%; z-index:3; mix-blend-mode:overlay; opacity:0.08;
      background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 300 300' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='grain'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23grain)'/%3E%3C/svg%3E"); }
    .slate-layers { position:absolute; top:0; left:0; width:100%; height:100%; z-index:4;
      background:
        radial-gradient(ellipse 80% 20% at 30% 25%,rgba(255,255,255,0.03) 0%,transparent 50%),
        radial-gradient(ellipse 60% 15% at 70% 60%,rgba(255,255,255,0.02) 0%,transparent 50%),
        radial-gradient(ellipse 90% 25% at 50% 80%,rgba(255,255,255,0.025) 0%,transparent 50%),
        repeating-linear-gradient(182deg,transparent 0px,transparent 6px,rgba(255,255,255,0.012) 7px,transparent 8px,transparent 15px,rgba(0,0,0,0.03) 16px,transparent 17px,transparent 25px); }
    .slate-edge { position:absolute; top:0; left:0; width:100%; height:100%; z-index:6; pointer-events:none;
      background:linear-gradient(135deg,rgba(255,255,255,0.03) 0%,transparent 30%,transparent 70%,rgba(0,0,0,0.08) 100%);
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.03); }
    .slate-border { position:absolute; top:0; left:0; width:100%; height:100%; z-index:10; pointer-events:none;
      box-shadow:inset 0 0 10px 3px rgb(20,22,24); }
    .slate canvas { position:absolute; top:0; left:0; width:100%; height:100%; z-index:7; mix-blend-mode:screen; }

    /* REVIEWS */
    .reviews { display:flex; gap:12px; margin-top:20px; max-width:620px; width:100%; }
    .testimonial { flex:1; background:var(--card-bg); border-radius:12px; padding:14px 14px; box-shadow:var(--shadow-soft); }
    .testimonial .stars { color:#f5a623; font-size:0.75rem; letter-spacing:2px; margin-bottom:4px; }
    .testimonial .quote { font-size:0.72rem; color:var(--text-medium); font-style:italic; line-height:1.4; margin-bottom:5px; }
    .testimonial .author { font-size:0.58rem; color:var(--text-light); font-weight:500; }

    /* LOC MENU */
    .loc-menu { position:absolute; left:0; right:0; top:calc(100% + 4px); background:var(--card-bg); border:1px solid var(--border-light); border-radius:10px; z-index:50; max-height:200px; overflow-y:auto; -webkit-overflow-scrolling:touch; box-shadow:var(--shadow-medium); }
    .loc-item { padding:10px 12px; cursor:pointer; font-size:.82rem; color:var(--text-medium); border-bottom:1px solid var(--border-light); }
    .loc-item:hover,.loc-item:active { background:var(--bg-cream); }

    /* MOBILE */
    @media(max-width:860px){
      body{padding:0;padding-bottom:76px}
      .app{grid-template-columns:1fr;gap:0;max-width:100%}
      .sidebar{order:1;border-radius:0 0 20px 20px;border:none;border-bottom:1px solid var(--border-light);padding:16px 14px 20px;box-shadow:none}
      .preview{order:2;padding:16px 10px 20px}
      .slate{width:100%;max-width:400px;height:auto;aspect-ratio:1;box-shadow:0 15px 40px rgba(0,0,0,.3)}
      .brand-header{padding-bottom:10px;margin-bottom:10px}
      .brand-name{font-size:1.3rem}
      .intro{font-size:0.72rem;margin-bottom:10px}
      .specs-box{padding:6px;font-size:0.72rem;margin-bottom:10px}
      .group{margin-bottom:8px}
      label{font-size:0.55rem;margin-bottom:2px}
      input:not([type="checkbox"]),select{padding:8px 9px;font-size:0.8rem}
      .toggle-check{width:20px;height:20px;min-width:20px}
      .info-box{font-size:0.6rem;padding:6px 8px}
      .chip{padding:4px 9px;font-size:0.63rem}
      .chip-cat{font-size:0.5rem}
      .cta-area{position:fixed;bottom:0;left:0;right:0;z-index:100;background:var(--card-bg);border-top:1px solid var(--border-light);padding:10px 14px;box-shadow:0 -4px 20px rgba(0,0,0,0.08)}
      .trust-bar{display:none}
      .reviews{flex-direction:column;gap:8px;padding:0 10px;max-width:400px}
      .loc-menu{max-height:160px}
      .loc-item{padding:10px;font-size:0.8rem}
    }
    @media(max-width:380px){
      .sidebar{padding:12px 10px 16px}
      .brand-name{font-size:1.15rem}
      input:not([type="checkbox"]),select{padding:7px 8px;font-size:0.78rem}
      .group{margin-bottom:7px}
      .chip{padding:3px 7px;font-size:0.6rem}
    }
  </style>
</head>
<body>
<div class="app">
  <div class="sidebar">
    <div class="brand-header">
      <div class="brand-name">Get Your Boxx</div>
      <div class="brand-tagline">Dein Moment in Stein</div>
      <div class="logo-mark"></div>
    </div>
    <div class="specs-box">Schieferplatte 20√ó20cm</div>
    <p class="intro">Konfiguriere deine pers√∂nliche Sternenkarte.<br>Exakt berechnet nach Ort &amp; Zeit.<br>F√ºr die Ewigkeit graviert.</p>

    <div class="group">
      <label>1. Schnellwahl (Inspiration)</label>
      <div class="chips">
        <div class="chip-cat">‚ù§Ô∏è Liebe</div>
        <div class="chip" onclick="applyChip(this)">Unser erster Kuss</div>
        <div class="chip" onclick="applyChip(this)">Ja, ich will</div>
        <div class="chip" onclick="applyChip(this)">In den Sternen geschrieben</div>
        <div class="chip-cat">üë∂ Geburt</div>
        <div class="chip" onclick="applyChip(this)">Ein Stern ist geboren</div>
        <div class="chip" onclick="applyChip(this)">Willkommen auf der Erde</div>
        <div class="chip-cat">‚ú® Allgemein</div>
        <div class="chip" onclick="applyChip(this)">Der Sternenhimmel</div>
        <div class="chip" onclick="applyChip(this)">Unsere Nacht</div>
        <div class="chip" onclick="applyChip(this)">Hier fing alles an</div>
      </div>
    </div>

    <div class="group">
      <label>2. √úberschrift (Max 24 Zeichen)</label>
      <div class="input-row">
        <input type="text" id="title" class="missing" placeholder="Name oder Satz..." maxlength="24" oninput="markTouched(this.id);validateAndRender()">
        <input type="checkbox" id="checkTitle" class="toggle-check" checked onchange="toggleField('title','checkTitle')">
      </div>
    </div>

    <div class="group">
      <label>3. Datum</label>
      <div class="input-row">
        <input type="date" id="date" class="missing" oninput="markTouched(this.id);validateAndRender()">
        <input type="checkbox" id="checkDate" class="toggle-check" checked onchange="toggleField('date','checkDate')">
      </div>
    </div>

    <div class="group">
      <label>4. Uhrzeit (Optional)</label>
      <div class="input-row">
        <input type="time" id="time" value="22:00" disabled oninput="markTouched(this.id);validateAndRender()">
        <input type="checkbox" id="checkTime" class="toggle-check" onchange="toggleField('time','checkTime')">
      </div>
    </div>

    <div class="group">
      <label>5. Ort (f√ºr Sterne &amp; Text)</label>
      <div class="input-row">
        <div style="position:relative;flex-grow:1">
          <input type="text" id="loc" placeholder="Stadt..." disabled oninput="markTouched('loc');debouncedSearch()" autocomplete="off">
          <div id="locMenu" class="loc-menu" hidden></div>
        </div>
        <input type="checkbox" id="checkLoc" class="toggle-check" onchange="toggleField('loc','checkLoc')">
      </div>
      <div id="locStatus" class="status"></div>
    </div>

    <div class="group">
      <label>Dein Paket</label>
      <div class="info-box" style="border-left-color:var(--copper); background:rgba(232,159,2,0.04); font-size:0.78rem; padding:12px 14px; line-height:1.6">
        <strong>Schieferplatte 20√ó20cm</strong> aus echtem Naturschiefer<br>
        <strong>Holzst√§nder</strong> passend zum Aufstellen<br>
        <strong>Lasergravur</strong> deiner pers√∂nlichen Sternenkarte<br>
        <strong>Versand</strong> kostenlos mit DHL (2‚Äì4 Werktage)
      </div>
    </div>

    <div class="cta-area">
      <div class="btn-row">
        <div class="price-tag">
          <span class="amount">50‚Ç¨</span>
          <span class="price-sub">inkl. St√§nder<br>&amp; Versand</span>
        </div>
        <button id="waBtn" class="btn-wa" onclick="sendWhatsApp()" disabled>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.582 2.128 2.182-.573c.978.58 1.911.928 3.145.929 3.178 0 5.767-2.587 5.768-5.766 0-3.18-2.587-5.771-5.764-5.771zm3.392 8.244c-.144.405-.837.774-1.17.824-.299.045-.677.063-1.092-.069-.252-.08-.575-.187-.988-.365-1.739-.747-2.874-2.512-2.96-2.626-.088-.113-.716-.953-.716-1.819 0-.866.454-1.292.616-1.463.162-.171.353-.214.471-.214.118 0 .236.002.339.006.11.004.258-.042.404.31.147.352.502 1.223.546 1.312.044.089.074.192.015.31-.059.118-.088.192-.177.296-.088.103-.186.231-.265.31-.088.089-.18.186-.077.363.103.177.458.756.983 1.224.675.602 1.244.789 1.421.877.177.088.281.074.384-.044.103-.118.442-.516.56-.693.118-.177.236-.148.398-.089.162.059 1.032.487 1.209.576.177.088.295.133.338.207.044.074.044.428-.1.833z"/></svg>
          <span class="cta-text"><strong>Unverbindlich anfragen</strong><small>kostenlos ‚Ä¢ per WhatsApp</small></span>
        </button>
      </div>
      <div class="trust-bar">
        <div class="trust-item"><span>üá©üá™</span>Handgefertigt</div>
        <div class="trust-item"><span>üì¶</span>2‚Äì4 Werktage</div>
        <div class="trust-item"><span>üõ°Ô∏è</span>Zufriedenheitsgarantie</div>
      </div>
    </div>
  </div>

  <div class="preview">
    <div class="slate">
      <div class="slate-base"></div>
      <div class="slate-texture"></div>
      <div class="slate-grain"></div>
      <div class="slate-layers"></div>
      <div class="slate-edge"></div>
      <div class="slate-border"></div>
      <canvas id="cvs"></canvas>
    </div>
    <div class="reviews">
      <div class="testimonial">
        <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
        <div class="quote">‚ÄûWundersch√∂n graviert. Meine Freundin hatte Tr√§nen in den Augen!"</div>
        <div class="author">‚Äî Luisa, Berlin</div>
      </div>
      <div class="testimonial">
        <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
        <div class="quote">‚ÄûHaben es zur Taufe verschenkt. Sieht in echt noch besser aus als auf dem Bild."</div>
        <div class="author">‚Äî Marco, M√ºnchen</div>
      </div>
      <div class="testimonial">
        <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
        <div class="quote">‚ÄûSuper schnelle Lieferung und die Qualit√§t ist top. Bestelle definitiv nochmal."</div>
        <div class="author">‚Äî Sarah, Hamburg</div>
      </div>
    </div>
  </div>
</div>

<script>
  // ========================
  // CONFIG
  // ========================
  const MY_PHONE = "4915224242302";
  const API_KEY = "08f31ef48294759c12765e4bf81e8b9d"; // Hinweis: im Frontend immer √∂ffentlich sichtbar.

  const IS_MOBILE = window.innerWidth <= 860;
  const S = IS_MOBILE ? 1200 : 2362;

  const cvs = document.getElementById('cvs');
  cvs.width = S;
  cvs.height = S;
  const ctx = cvs.getContext('2d');

  let GEO = { lat: 51.16, lon: 10.45, name: '' };
  let SUGGESTIONS = [];
  let timer;

  // ========================
  // TOUCHED-STATE (Fix)
  // ========================
  const TOUCH_IDS = ['title','date','time','loc'];
  function initTouched(){
    TOUCH_IDS.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.dataset.touched = '0';
    });
  }
  function markTouched(id){
    const el = document.getElementById(id);
    if (el && !el.disabled) el.dataset.touched = '1';
  }
  initTouched();

  window.onload = function(){
    const dateEl = document.getElementById('date');
    dateEl.valueAsDate = new Date();
    // wichtig, sonst bleibt das Datum ‚Äûmissing‚Äú
    dateEl.dataset.touched = '1';

    // Default Berlin (kannst du sp√§ter per Browser-Geolocation ersetzen)
    GEO = { lat: 52.52, lon: 13.40, name: '' };

    validateAndRender();
  };

  // Close location menu on outside click
  document.addEventListener('click', (e) => {
    const menu = document.getElementById('locMenu');
    const inp = document.getElementById('loc');
    if (!menu || menu.hidden) return;
    if (e.target !== inp && !menu.contains(e.target)) hideLocMenu();
  });

  // ========================
  // UI HELPERS
  // ========================
  function applyChip(el){
    const v = el.textContent.trim();
    const t = document.getElementById('title');
    t.value = v;
    markTouched('title');
    setValidity(t, true);

    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');

    validateAndRender();
  }

  function setValidity(el, ok){
    if (!el) return;
    if (ok) {
      el.classList.remove('missing');
      el.classList.add('valid');
    } else {
      el.classList.add('missing');
      el.classList.remove('valid');
    }
  }

  function toggleField(id, cid){
    const c = document.getElementById(cid).checked;
    const el = document.getElementById(id);
    el.disabled = !c;
    el.classList.remove('valid','missing');
    if (id === 'loc') document.getElementById('locStatus').innerText = c ? 'Pflichtfeld' : '';
    validateAndRender();
  }

  function validateAndRender(){
    let ok = true;

    const chk = (id, cid, fn) => {
      const el = document.getElementById(id);
      const cb = document.getElementById(cid);
      if (!cb.checked) {
        el.classList.remove('missing','valid');
        return true;
      }
      const v = fn(el.value);
      setValidity(el, v);
      return v;
    };

    if (!chk('title','checkTitle', v => v.trim().length > 0)) ok = false;
    if (!chk('date','checkDate', v => v !== '')) ok = false;

    if (document.getElementById('checkTime').checked && !document.getElementById('time').value) ok = false;
    if (document.getElementById('checkLoc').checked && document.getElementById('loc').value.trim().length < 2) ok = false;

    document.getElementById('waBtn').disabled = !ok;
    render();
  }

  // ========================
  // WhatsApp + Upload (Fix)
  // ========================
  async function sendWhatsApp(){
    const btn = document.getElementById('waBtn');
    const orig = btn.innerHTML;

    btn.innerHTML =
      '<svg class="spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
      '<circle cx="12" cy="12" r="10" stroke-opacity="0.3"/>' +
      '<path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/></svg>' +
      '<span class="cta-text"><strong>Lade hoch...</strong><small>Bitte kurz warten</small></span>';

    btn.disabled = true;

    const title = document.getElementById('title').value.trim();
    const date = document.getElementById('date').value;

    const timeCheck = document.getElementById('checkTime').checked;
    const timeVal = timeCheck ? (document.getElementById('time').value || 'Nicht angegeben') : 'Nicht angegeben';

    const locCheck = document.getElementById('checkLoc').checked;
    const locVal = locCheck ? (document.getElementById('loc').value.trim() || 'Nicht angegeben') : 'Standard (Berlin)';

    const font = 'Montserrat';

    let imageUrl = "[Upload ausstehend]";

    // Generate image data
    let uploadData;
    if (IS_MOBILE) {
      const hq = document.createElement('canvas');
      hq.width = 2362;
      hq.height = 2362;
      renderToCtx(hq.getContext('2d'), 2362, true);
      uploadData = hq.toDataURL('image/png').split(',')[1];
    } else {
      uploadData = cvs.toDataURL('image/png').split(',')[1];
    }

    // Upload
    try {
      const fd = new FormData();
      fd.append('key', API_KEY);
      fd.append('image', uploadData);
      const r = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: fd });
      const j = await r.json();
      imageUrl = (j && j.success && j.data && j.data.url) ? j.data.url : '[Upload fehlgeschlagen]';
    } catch(e) {
      imageUrl = '[Upload Fehler]';
    }

    const msg =
`Hallo Get Your Boxx! Ich m√∂chte eine Sternen-Platte anfragen:
Design: ${title || '[Titel fehlt]'}
Datum: ${date || '[Datum fehlt]'}
Uhrzeit: ${timeVal}
Ort: ${locVal}
Schrift: ${font}
Gr√∂√üe: 20x20 cm + Holzst√§nder

Mein Entwurf: ${imageUrl}

Bitte meldet euch f√ºr die Details!`;

    window.location.href = `https://wa.me/${MY_PHONE}?text=${encodeURIComponent(msg)}`;

    setTimeout(() => {
      btn.innerHTML = orig;
      btn.disabled = false;
    }, 1200);
  }

  // ========================
  // GEO SEARCH
  // ========================
  function debouncedSearch(){
    const inp = document.getElementById('loc');
    const v = inp.value.trim();
    const cb = document.getElementById('checkLoc');

    if (cb.checked) setValidity(inp, v.length > 1);
    document.getElementById('locStatus').innerText = v.length > 1 ? '‚è≥ Suche...' : '';

    if (v.length < 2) hideLocMenu();

    clearTimeout(timer);
    timer = setTimeout(() => geocode(v), 380);
  }

  async function geocode(q){
    if (!document.getElementById('checkLoc').checked || !q || q.length < 2) {
      hideLocMenu();
      return;
    }
    try {
      const r = await fetch('https://photon.komoot.io/api/?limit=6&lang=de&q=' + encodeURIComponent(q));
      const j = await r.json();
      SUGGESTIONS = j.features.map(f => {
        const p = f.properties;
        return {
          label: [p.name, p.city, p.country].filter(Boolean).join(', '),
          lat: f.geometry.coordinates[1],
          lon: f.geometry.coordinates[0],
          name: p.city || p.name || q
        };
      });
      if (SUGGESTIONS.length) renderLocMenu();
    } catch(e) {
      // silent
    }
  }

  function applyGeo(s){
    GEO = s;
    document.getElementById('loc').value = s.label || s.name;
    hideLocMenu();
    render();
  }

  function renderLocMenu(){
    const m = document.getElementById('locMenu');
    m.innerHTML = '';
    m.hidden = false;
    SUGGESTIONS.forEach(s => {
      const d = document.createElement('div');
      d.className = 'loc-item';
      d.innerText = s.label;
      d.onmousedown = e => { e.preventDefault(); applyGeo(s); };
      d.ontouchstart = () => applyGeo(s);
      m.appendChild(d);
    });
  }

  function hideLocMenu(){
    document.getElementById('locMenu').hidden = true;
  }

  // ========================
  // Star Data
  // ========================
  function getMoonPhase(d){
    const lp = 2551443;
    const nm = new Date(1970,0,7,20,35,0).getTime();
    const p = ((d.getTime() - nm) % lp) / lp;
    return p < 0 ? p + 1 : p;
  }

  function drawTT(c, text, x, y, tr){
    if (!text) return;
    const ch = Array.from(text);
    let tot = 0;
    for (const a of ch) tot += c.measureText(a).width;
    tot += tr * (ch.length - 1);
    let sx = x - tot / 2;
    for (const a of ch) {
      c.fillText(a, sx + c.measureText(a).width / 2, y);
      sx += c.measureText(a).width + tr;
    }
  }

  let STATIC_BG = [];
  function initBG(size){
    STATIC_BG = [];
    const px = size / 20;
    const rad = 7 * px;
    const cnt = size > 1500 ? 9000 : 4500;
    for (let i=0;i<cnt;i++){
      let r = Math.sqrt(Math.random()) * rad;
      let a = Math.random() * Math.PI * 2;
      let bb = Math.abs(Math.cos(a - 0.8));
      if (Math.random() > (0.3 + 0.7 * bb)) {
        if (Math.random() > 0.2) continue;
      }
      STATIC_BG.push({ x: r * Math.cos(a), y: r * Math.sin(a), sz: size > 1500 ? (Math.random()*0.8+0.8) : (Math.random()*0.6+0.6) });
    }
  }
  initBG(S);

  const STARS=[
    {id:1,ra:6.75,dec:-16.7,mag:-1.46,n:"SIRIUS"},{id:2,ra:14.26,dec:19.1,mag:-0.05,n:"ARKTUR"},{id:3,ra:5.24,dec:-8.2,mag:0.18,n:"RIGEL"},{id:4,ra:5.92,dec:7.4,mag:0.45,n:"BETEIGEUZE"},{id:5,ra:18.62,dec:38.8,mag:0.03,n:"WEGA"},{id:6,ra:7.66,dec:5.2,mag:0.38,n:"PROKYON"},{id:7,ra:5.28,dec:46.0,mag:0.08,n:"CAPELLA"},{id:8,ra:13.42,dec:-11.2,mag:1.04,n:"SPICA"},{id:9,ra:16.49,dec:-26.4,mag:1.06,n:"ANTARES"},{id:10,ra:19.85,dec:8.9,mag:0.77,n:"ALTAIR"},{id:11,ra:20.69,dec:45.3,mag:1.25,n:"DENEB"},{id:12,ra:4.60,dec:16.5,mag:0.86,n:"ALDEBARAN"},{id:13,ra:2.53,dec:89.3,mag:1.98,n:"POLARIS"},{id:14,ra:10.14,dec:11.9,mag:1.35,n:"REGULUS"},{id:15,ra:7.58,dec:31.9,mag:1.58,n:"CASTOR"},{id:16,ra:7.76,dec:28.0,mag:1.14,n:"POLLUX"},
    {id:101,ra:11.06,dec:61.8,mag:1.8},{id:102,ra:11.03,dec:56.4,mag:2.4},{id:103,ra:11.90,dec:53.7,mag:2.4},{id:104,ra:12.26,dec:57.0,mag:2.4},{id:105,ra:12.90,dec:56.0,mag:1.8},{id:106,ra:13.40,dec:54.9,mag:2.2},{id:107,ra:13.79,dec:49.3,mag:1.9},
    {id:110,ra:17.54,dec:71.8,mag:2.0},{id:111,ra:15.34,dec:71.9,mag:3.0},
    {id:120,ra:0.67,dec:56.5,mag:2.2},{id:121,ra:1.91,dec:63.7,mag:2.3},{id:122,ra:1.43,dec:60.2,mag:2.7},{id:123,ra:0.95,dec:60.7,mag:2.2},{id:124,ra:0.15,dec:59.1,mag:3.0},
    {id:132,ra:5.60,dec:-1.2,mag:1.7},{id:133,ra:5.68,dec:-1.9,mag:1.7},{id:134,ra:5.82,dec:9.9,mag:1.6},{id:135,ra:5.41,dec:-2.4,mag:2.2},{id:136,ra:5.53,dec:-0.3,mag:2.8},
    {id:140,ra:20.46,dec:33.9,mag:2.2},{id:141,ra:19.51,dec:27.9,mag:3.0},
    {id:180,ra:23.08,dec:15.2,mag:2.5},{id:181,ra:23.06,dec:28.1,mag:2.4},{id:182,ra:0.13,dec:29.1,mag:2.1},{id:183,ra:0.22,dec:15.2,mag:2.8},
    {id:161,ra:11.82,dec:14.6,mag:2.1},{id:162,ra:10.33,dec:19.8,mag:2.0},
    {id:171,ra:17.56,dec:-37.1,mag:1.6},{id:172,ra:16.20,dec:-19.5,mag:2.3},
    {id:190,ra:1.16,dec:35.6,mag:2.1},{id:191,ra:2.06,dec:42.3,mag:2.1}
  ];

  const LINES=[
    [101,102],[102,103],[103,104],[104,105],[105,106],[106,107],[13,111],[111,110],
    [120,123],[123,122],[122,121],[121,124],[132,133],[133,135],[134,132],[134,4],[4,133],[133,3],[3,136],
    [11,140],[140,141],[140,5],[11,5],[15,16],[14,162],[162,161],[172,9],[9,171],
    [180,181],[181,182],[182,183],[183,180],[182,190],[190,191],[5,10],[10,11],[11,5],[101,13]
  ];

  // ========================
  // Render
  // ========================
  function renderToCtx(c, size, isHQ){
    const sc = size / 2362;
    const px = size / 20;

    c.fillStyle = 'black';
    c.fillRect(0,0,size,size);

    let dV = document.getElementById('date').value;
    if (!dV) dV = new Date().toISOString().split('T')[0];

    const tV = document.getElementById('time').value || '12:00';
    const dO = new Date(dV + 'T' + tV);

    const sT = document.getElementById('checkTitle').checked;
    const sD = document.getElementById('checkDate').checked;
    const sTi = document.getElementById('checkTime').checked;
    const sL = document.getElementById('checkLoc').checked;

    let title = document.getElementById('title').value;
    if (sT && !title) title = '[ NAME ]';

    let l1 = '';
    let l2 = '';

    // Sidereal time approx
    const jd = (dO.getTime()/86400000) + 2440587.5;
    const t = 18.697374558 + 24.06570982441908 * (jd - 2451545.0);
    const LST = (t + GEO.lon/15.0) % 24;
    const fDec = GEO.lat;

    if (sD) l1 = dO.toLocaleDateString('de-DE',{year:'numeric',month:'long',day:'numeric'});

    let locT = '';
    if (sL) {
      let l = document.getElementById('loc').value;
      locT = l.trim().length > 1 ? (GEO.name || l) : '[ ORT ]';
    }

    let timeT = '';
    if (sTi) {
      let tt = document.getElementById('time').value;
      if (tt) timeT = tt + ' Uhr';
    }

    if (locT && timeT) l2 = locT + ' ‚Ä¢ ' + timeT;
    else if (locT) l2 = locT;
    else if (timeT) l2 = timeT;

    const rad = 7 * px;
    const cx = size / 2;
    const cy = size / 2;

    // Clip circle
    c.save();
    c.beginPath();
    c.arc(cx,cy,rad,0,Math.PI*2);
    c.clip();

    // Grid
    c.strokeStyle='rgba(255,255,255,0.12)';
    c.lineWidth=1;
    c.setLineDash([4,12]);

    c.beginPath(); c.arc(cx,cy,rad*0.33,0,Math.PI*2); c.stroke();
    c.beginPath(); c.arc(cx,cy,rad*0.66,0,Math.PI*2); c.stroke();
    for (let i=0;i<8;i++){
      const a = i*(Math.PI/4);
      c.beginPath();
      c.moveTo(cx,cy);
      c.lineTo(cx + rad*Math.cos(a), cy + rad*Math.sin(a));
      c.stroke();
    }
    c.setLineDash([]);

    // Stars background
    c.fillStyle='white';
    if (isHQ) {
      const bg=[];
      for (let i=0;i<9000;i++){
        let r = Math.sqrt(Math.random())*rad;
        let a = Math.random()*Math.PI*2;
        let bb = Math.abs(Math.cos(a-0.8));
        if (Math.random()>(0.3+0.7*bb)) { if (Math.random()>0.2) continue; }
        bg.push({x:r*Math.cos(a), y:r*Math.sin(a), sz:Math.random()*0.8+0.8});
      }
      for (const b of bg) c.fillRect(cx+b.x, cy+b.y, b.sz, b.sz);
    } else {
      for (const b of STATIC_BG) c.fillRect(cx+b.x, cy+b.y, b.sz, b.sz);
    }

    // Star projection (simple alt/az)
    const sp = {};
    for (const s of STARS) {
      const ha = (LST - s.ra) * 15 * (Math.PI/180);
      const dec = s.dec * (Math.PI/180);
      const lat = fDec * (Math.PI/180);

      const sinA = Math.sin(dec)*Math.sin(lat) + Math.cos(dec)*Math.cos(lat)*Math.cos(ha);
      const alt = Math.asin(sinA);
      if (alt <= 0) continue;

      const rr = rad * Math.tan((Math.PI/2 - alt)/2);
      let az = Math.acos((Math.sin(dec) - sinA*Math.sin(lat)) / (Math.cos(alt)*Math.cos(lat)));
      if (Math.sin(ha) > 0) az = 2*Math.PI - az;

      const x = cx + rr*Math.sin(az);
      const y = cy - rr*Math.cos(az);
      sp[s.id] = { x, y };

      const sz = (2.8 + (10.5-2.8) * Math.pow((3.2 - s.mag)/4.8, 1.6)) * sc;
      c.beginPath();
      c.arc(x,y,sz,0,Math.PI*2);
      c.fill();

      if (s.n) {
        c.font = 'bold ' + Math.round(22*sc) + 'px sans-serif';
        c.textAlign = 'center';
        c.textBaseline = 'bottom';
        c.fillText(s.n, x, y - (sz + 10*sc));
      }
    }

    // Lines
    c.strokeStyle='rgba(255,255,255,0.85)';
    c.lineWidth=3*sc;
    c.lineCap='round';
    c.beginPath();
    for (const [a,b] of LINES) {
      if (sp[a] && sp[b]) {
        c.moveTo(sp[a].x, sp[a].y);
        c.lineTo(sp[b].x, sp[b].y);
      }
    }
    c.stroke();

    c.restore();

    // Outer ticks
    c.strokeStyle='white';
    c.lineWidth=2*sc;
    const iR = rad + 8*sc;
    for (let i=0;i<360;i+=2){
      const a = (i-90) * (Math.PI/180);
      const len = (i%90===0) ? 25*sc : (i%10===0 ? 18*sc : 8*sc);
      c.beginPath();
      c.moveTo(cx + iR*Math.cos(a), cy + iR*Math.sin(a));
      c.lineTo(cx + (iR+len)*Math.cos(a), cy + (iR+len)*Math.sin(a));
      c.stroke();
    }

    // Compass
    c.fillStyle='white';
    c.font='bold ' + Math.round(50*sc) + 'px Cinzel';
    c.textAlign='center';
    c.textBaseline='middle';
    c.fillText('N', cx, cy - (rad + 60*sc));
    c.fillText('O', cx + (rad + 60*sc), cy);
    c.fillText('S', cx, cy + (rad + 60*sc));
    c.fillText('W', cx - (rad + 60*sc), cy);

    // Border
    c.lineWidth=4*sc;
    c.beginPath();
    c.arc(cx,cy,rad,0,Math.PI*2);
    c.stroke();

    // Title & bottom text
    c.textBaseline='alphabetic';

    if (sT) {
      c.font = Math.round(85*sc) + 'px Montserrat';
      if (!document.getElementById('title').value) c.fillStyle = '#666';
      drawTT(c, title, size/2, 1.5*px, 0);
      c.fillStyle = 'white';
    }

    const bY = size - (1.0*px);
    if (l2) {
      c.font = '300 ' + Math.round(40*sc) + 'px Montserrat';
      drawTT(c, l2, size/2, bY, 2*sc);
      c.font = '700 ' + Math.round(75*sc) + 'px Montserrat';
      drawTT(c, l1, size/2, bY - 90*sc, 2*sc);
    } else {
      c.font = '700 ' + Math.round(75*sc) + 'px Montserrat';
      drawTT(c, l1, size/2, bY - 45*sc, 2*sc);
    }

    // Moon icon
    if (sD) {
      const p = getMoonPhase(dO);
      const dw = c.measureText(l1).width;
      const mx = size/2 + dw/2 + 70*sc;
      const my = l2 ? (bY - 115*sc) : (bY - 70*sc);

      c.beginPath();
      c.arc(mx,my,22*sc,0,Math.PI*2);
      c.lineWidth=2*sc;
      c.strokeStyle='white';
      c.stroke();

      if (p>0.05 && p<0.95) {
        c.beginPath();
        c.arc(mx,my,22*sc,-Math.PI/2,Math.PI/2,p<0.5);
        c.fill();
      }
    }
  }

  function render(){
    if (!ctx) return;
    renderToCtx(ctx, S, false);
  }
</script>
</body>
</html>
